#!/usr/bin/env python3
"""
Pre-Compact Hook - Context Preservation

When Claude Code context fills up, preserve critical information:
1. Save current workflow state
2. Save agent summaries (context firewalls)
3. Save human decisions/approvals
4. Create continuation guide for next session

This ensures no loss of progress when context resets.
"""

import json
from pathlib import Path
from datetime import datetime


def main():
    print("üíæ PreCompact Hook - Preserving Context")
    print("="*60)

    autoflow_dir = Path.cwd() / ".autoflow"
    state_dir = autoflow_dir / "state"
    state_dir.mkdir(parents=True, exist_ok=True)

    # Timestamp for this save
    timestamp = datetime.now().strftime("%Y%m%d-%H%M%S")

    # 1. Save workflow state
    print("\nüìä Saving workflow state...")
    workflow_state = {
        "timestamp": timestamp,
        "current_phase": get_current_phase(),
        "active_issues": get_active_issues(),
        "active_worktrees": get_active_worktrees(),
        "last_checkpoint": get_last_checkpoint()
    }

    state_file = state_dir / f"workflow-state-{timestamp}.json"
    with open(state_file, 'w') as f:
        json.dump(workflow_state, f, indent=2)

    print(f"   Saved to: {state_file}")

    # 2. Collect all context firewall summaries
    print("\nüìÑ Collecting context firewall summaries...")
    firewall_dir = autoflow_dir / "context-firewalls"
    summaries = []

    if firewall_dir.exists():
        for summary_file in firewall_dir.glob("*.md"):
            summaries.append({
                "file": str(summary_file),
                "modified": summary_file.stat().st_mtime
            })

    print(f"   Found {len(summaries)} summaries")

    # 3. Create continuation guide
    print("\nüìù Creating continuation guide...")
    continuation = create_continuation_guide(workflow_state, summaries)

    continuation_file = state_dir / f"CONTINUE-FROM-{timestamp}.md"
    with open(continuation_file, 'w') as f:
        f.write(continuation)

    print(f"   Saved to: {continuation_file}")

    # 4. Summary
    print("\n" + "="*60)
    print("‚úÖ Context preserved successfully!")
    print("")
    print("üìã Next session:")
    print(f"   1. Read: {continuation_file}")
    print(f"   2. Review summaries in: {firewall_dir}")
    print(f"   3. Continue workflow from: {workflow_state['current_phase']}")
    print("")


def get_current_phase():
    """Determine current workflow phase"""
    # TODO: Implement actual phase detection
    return "implementation"


def get_active_issues():
    """Get active GitHub Issues"""
    # TODO: Query GitHub Issues
    return []


def get_active_worktrees():
    """Get active git worktrees"""
    import subprocess
    result = subprocess.run(['git', 'worktree', 'list'], capture_output=True, text=True)
    worktrees = []
    for line in result.stdout.split('\n'):
        if line and 'worktrees/' in line:
            worktrees.append(line.split()[0])
    return worktrees


def get_last_checkpoint():
    """Get last human checkpoint decision"""
    # TODO: Read from checkpoint log
    return {"type": "research_approval", "approved": True}


def create_continuation_guide(workflow_state, summaries):
    """Create guide for continuing in next session"""
    guide = f"""# AutoFlow - Session Continuation Guide

**Generated**: {workflow_state['timestamp']}

## Where We Left Off

**Current Phase**: {workflow_state['current_phase']}

**Active Issues**: {len(workflow_state['active_issues'])}

**Active Worktrees**: {len(workflow_state['active_worktrees'])}
{chr(10).join(f'  - {w}' for w in workflow_state['active_worktrees'])}

**Last Checkpoint**: {workflow_state['last_checkpoint']['type']}
  - Approved: {workflow_state['last_checkpoint']['approved']}

## Context Firewall Summaries

Found {len(summaries)} summaries from previous agents:
"""

    # Add summaries
    for summary in sorted(summaries, key=lambda x: x['modified'], reverse=True)[:10]:
        guide += f"\n- {Path(summary['file']).name}"

    guide += """

## Next Steps

1. **Resume workflow**:
   ```bash
   python .autoflow/agents/orchestrator.py [task-name]
   ```

2. **Review summaries**:
   ```bash
   ls -lt .autoflow/context-firewalls/
   ```

3. **Check active worktrees**:
   ```bash
   git worktree list
   ```

4. **Review active issues**:
   ```bash
   gh issue list --label "status:in-progress"
   ```

## Critical Information Preserved

- ‚úÖ Workflow state saved
- ‚úÖ Context firewall summaries available
- ‚úÖ Human decisions recorded
- ‚úÖ Active worktrees tracked
- ‚úÖ GitHub Issues linked

**You can continue exactly where you left off!**

---

*This guide was automatically generated by PreCompact hook*
"""

    return guide


if __name__ == '__main__':
    main()
